<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE task PUBLIC "-//OASIS//DTD DITA Task//EN" "task.dtd">
<task id="ReusableComponent_rtk_sb5_fyb">
    <title></title>
    <taskbody id="taskbody_utk_sb5_fyb"><context>Действия ниже описаны для случая, когда нужно создать и восстановить резервную копию файлов СУБД на одном и том же сервере. Если нужно создать резервную копию на одном сервере, а восстановить на другом, перенос файлов будет осуществляться между этими серверами, в остальном действия совпадают.</context><steps><step><cmd>Убедитесь, что на сервере для восстановления находится каталог с файлами, полученный в результате работы <codeph>pg_basebackup</codeph>. </cmd></step><step><cmd>Чтобы исключить запись в базу данных во время восстановления из копии, отключите <ph outputclass="udvpdf"><term keyref="udv_itm_k"/></ph><ph outputclass="onlypdf"><term keyref="datapk_itm_k"/></ph><ph outputclass="html"><term keyref="datapk_itm_k"/></ph> командой:</cmd><info><codeblock>docker-compose down</codeblock></info></step><step><cmd>Если резервная копия находится в архиве <codeph>.tar.gz</codeph>, разархивируйте ее:</cmd><info><codeblock>tar -xvzf /opt/backupdb/base.tar.gz -C /opt/backupdb/</codeblock></info></step><step><cmd>Для снижения риска ошибок при восстановлении исключите из резервной копии файлы в подкаталоге <codeph>/opt/backupdb/pg_wal/</codeph> и перенесите их в другую директорию: </cmd><info><codeblock>mkdir /opt/tmp_wal_arch
mv /opt/backupdb/pg_wal/archive_status/* /opt/tmp_wal_arch/</codeblock></info></step><step><cmd>Содержимое каталогов <codeph>pg_dynshmem/</codeph>, <codeph>pg_notify/</codeph>, <codeph>pg_serial/</codeph>, <codeph>pg_snapshots/</codeph>, <codeph>pg_stat_tmp/</codeph> и <codeph>pg_subtrans/</codeph> (но не сами эти каталоги) можно исключить из резервной копии (<codeph>/opt/backupdb</codeph>), так как оно будет инициализировано при запуске главного процесса.</cmd></step><step><cmd>Для начала операции резервного копирования остановите службу Jatoba:</cmd><info><codeblock id="codeblock_adg_jkh_3rb">systemctl stop jatoba-*</codeblock></info></step><step><cmd>Убедитесь, что на сервере достаточно свободного места для копирования текущего каталога кластера баз данных и всех табличных пространств. </cmd></step><step><cmd>Скопируйте весь текущий каталог кластера баз данных и все табличные пространства во временный каталог:</cmd><info><codeblock>mkdir /var/lib/jatoba/[jatoba_version]/old_data/
cp -r /var/lib/jatoba/[jatoba_version]/data/* /var/lib/jatoba/[jatoba_version]/old_data/     </codeblock>В этой команде <codeph>jatoba_version</codeph> — первая цифра версии Jatoba.</info><stepxmp>При использовании Jatoba 4.5 выполните команды:<codeblock>mkdir /var/lib/jatoba/4/old_data/
cp -r /var/lib/jatoba/4/data/* /var/lib/jatoba/4/old_data/</codeblock></stepxmp></step><step><cmd>Удалите все существующие файлы и подкаталоги из каталога кластера <codeph>/var/lib/jatoba/[jatoba_version]/data</codeph> и из корневых каталогов табличных пространств:</cmd><info><codeblock>rm -rf /var/lib/jatoba/[jatoba_version]/data/*</codeblock>В этой команде <codeph>jatoba_version</codeph> — первая цифра версии Jatoba.</info></step><step><cmd>Восстановите файлы базы данных из резервной копии файлов:</cmd><info><codeblock>cp -r /opt/backupdb/* /var/lib/jatoba/[jatoba_version]/data/</codeblock>В этой команде <codeph>jatoba_version</codeph> — первая цифра версии Jatoba.</info><stepxmp>При использовании Jatoba 4.5 выполните команду:<codeblock>cp -r /opt/backupdb/* /var/lib/jatoba/4/data/</codeblock></stepxmp></step><step><cmd>Скопируйте незаархивированные файлы с сегментами WAL из каталога с кластером баз данных до восстановления в новый каталог с помощью команды:</cmd><info><codeblock>cp -r /var/lib/jatoba/[jatoba_version]/old_data/pg_wal/0* /var/lib/jatoba/[jatoba_version]/data/pg_wal/</codeblock>В этой команде <codeph>jatoba_version</codeph> — первая цифра версии Jatoba.</info><stepxmp>При использовании Jatoba 4.5 выполните команду:<codeblock>cp -r /var/lib/jatoba/4/old_data/pg_wal/0* /var/lib/jatoba/4/data/pg_wal/</codeblock></stepxmp><info><note type="tip">При возникновении проблем с диском вы можете использовать файлы с сегментами WAL из резервной копии.</note></info></step><step><cmd>Для корректного запуска службы Jatoba задайте права доступа к файлам для пользователя, запускающего сервер, с помощью команд:</cmd><info><codeblock>chown -R postgres:postgres /var/lib/jatoba/[jatoba_version]/data
chmod 750 /var/lib/jatoba/[jatoba_version]/data     </codeblock></info><info>В этой команде <codeph>jatoba_version</codeph> — первая цифра версии Jatoba.</info><stepxmp>При использовании Jatoba 4.5 выполните команду:<codeblock>chown -R postgres:postgres /var/lib/jatoba/4/data
chmod 750 /var/lib/jatoba/4/data</codeblock></stepxmp></step><step><cmd>Запустите службу сервера баз данных :</cmd><info><codeblock>systemctl start jatoba-*</codeblock></info></step><step><cmd>Просмотрите логи текущего дня: </cmd><info><codeblock>ls -la var/lib/jatoba/[jatoba_version]/data/log</codeblock><p>В этой команде <codeph>jatoba_version</codeph> — первая цифра версии Jatoba.<note>Названия файлов логов Jatoba соответствуют дню недели.</note></p></info><stepxmp>При использовании Jatoba 4.5 выполните команду:<codeblock>ls -la var/lib/jatoba/4/data/log</codeblock></stepxmp><stepresult>В файле логов после перезапуска должно быть сообщение об успешном старте: «система БД готова принимать подключения».</stepresult></step><step><cmd>Включите <ph outputclass="udvpdf"><term keyref="udv_itm_k"/></ph><ph outputclass="onlypdf"><term keyref="datapk_itm_k"/></ph><ph outputclass="html"><term keyref="datapk_itm_k"/></ph> с помощью команд:</cmd><info><codeblock>cd /opt/itm-k
docker-compose up -d</codeblock></info></step><step>
                <cmd>После проверки работоспособности сервисов удалите директорию
                        <codeph>/var/lib/jatoba/[jatoba_version]/data/old_data</codeph>, где
                        <codeph>jatoba_version</codeph> — первая цифра версии Jatoba.</cmd>
            </step><step><cmd>Переместите обратно в каталог с резервной копией либо удалите директорию <codeph>/opt/tmp_wal_arch/</codeph>.</cmd></step></steps></taskbody>
</task>
