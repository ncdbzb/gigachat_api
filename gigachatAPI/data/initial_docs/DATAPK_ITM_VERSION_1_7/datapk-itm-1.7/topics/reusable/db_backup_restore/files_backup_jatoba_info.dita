<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE task PUBLIC "-//OASIS//DTD DITA Task//EN" "task.dtd">
<task id="ReusableComponent_utr_3b5_fyb">
    <title></title>
    <taskbody><steps id="steps_xtr_3b5_fyb"><step><cmd>Убедитесь в корректности настроек в файле <codeph>postgresql.conf</codeph>. Для этого: </cmd><substeps id="substeps_xzp_nlw_3wb"><substep><cmd>Откройте файл для редактирования: </cmd><info><codeblock>vi /var/lib/jatoba/[jatoba_version]/data/postgresql.conf</codeblock>В этой команде <codeph>jatoba_version</codeph> — первая цифра версии Jatoba.</info><stepxmp>При использовании Jatoba 4.5 выполните команду:<codeblock>vi /var/lib/jatoba/4/data/postgresql.conf</codeblock></stepxmp></substep><substep><cmd>Убедитесь, что в разделе # WRITE-AHEAD LOG переменные имеют следующие значения, в ином случае измените их:</cmd><info><codeblock>wal_level = replica
max_wal_size = 1GB
min_wal_size = 80MB
archive_mode = on
archive_command = 'test ! -f /var/lib/jatoba/[jatoba_version]/backups/%f &amp;&amp; cp %p/var/lib/jatoba/[jatoba_version]/backups/%f '</codeblock><ul id="ul_frj_slw_3wb"><li>Параметр <codeph>wal_level</codeph> со значением <codeph>replica</codeph> определяет, что в журнал записываются данные, необходимые для поддержки архивирования WAL (Write ahead log — журнал предзаписи) и репликации. </li><li>Параметры <codeph>min</codeph> и <codeph>max_wal_size</codeph> регулируют размер WAL-файла. </li><li>Включенный параметр <codeph>archive_mode</codeph> передает полные сегменты WAL в хранилище архива командой <codeph>archive_command</codeph>. </li><li>Параметр <codeph>archive_command</codeph> содержит команду для архивации завершенного сегмента WAL. Данная команда кроме копирования осуществляет контроль наличия файла — если файл находится в директории для хранения резервных копий, то команда копирования не выполнится и существующий файл не будет перезаписан. <note>Убедитесь, что указанные в команде пути для создания резервной копии WAL-файлов существуют — они могут отличаться в зависимости от версии СУБД.</note></li><li><codeph>jatoba_version</codeph> — первая цифра версии Jatoba.</li></ul></info></substep><substep><cmd>Сохраните изменения и закройте файл:</cmd><info><codeblock>:wq</codeblock></info></substep></substeps></step><step><cmd>Убедитесь, что в файле <codeph conref="../filepath/pg_hba_conf.dita#ReusableComponent_gtb_nxd_yrb/codeph_htb_nxd_yrb"/> есть строка с правами replication для пользователя postgres. При необходимости раскомментируйте строку и измените метод аутентификации с ident на md5:</cmd><info><codeblock>host replication postgres 127.0.0.1/32 md5</codeblock></info></step><step><cmd>Для применения изменений в файлах <codeph>postgresql.conf</codeph> и <codeph conref="../filepath/pg_hba_conf.dita#ReusableComponent_gtb_nxd_yrb/codeph_htb_nxd_yrb"/> перезапустите службу СУБД:</cmd><info><codeblock>systemctl restart jatoba-*</codeblock></info></step><step><cmd>Создайте резервную копию файлов СУБД Jatoba от имени пользователя баз данных с правами супер-пользователя:</cmd><info><codeblock>pg_basebackup -p &lt;port> -h &lt;host> -U &lt;db_user> -D &lt;dir> -Ft -z -Xf -P -v</codeblock>Где:<ul id="ul_qfq_xzc_lwb"><li>port — порт подключения;</li><li>host — имя или IP-адрес компьютера, на котором работает сервер;</li><li>db_user — имя пользователя;</li><li>dir — директория, где будет хранится копия файлов из каталога «data» СУБД Jatoba.</li></ul></info><info><note>Подробную информацию о параметрах <codeph>pg_basebackup</codeph> можно узнать с помощью команды: <codeblock>pg_basebackup --help</codeblock></note></info><stepxmp>Команда для создания резервной копии файлов БД с портом <codeph>10265</codeph>, IP-адресом сервера <codeph>127.0.0.1</codeph> и пользователем <codeph>postgres</codeph> в директории <codeph>/opt/backupdb</codeph> будет выглядеть следующим образом:<codeblock>pg_basebackup -p 10265 -h 127.0.0.1 -U postgres -D /opt/backupdb -Ft -z -Xf -P -v</codeblock><p>Где ключи, используемые в команде, означают:</p><ul id="ul_imx_tmw_3wb"><li>-p — порт для подключения;</li><li>-h — имя или IP-адрес компьютера, на котором работает сервер;</li><li>-U — пользователь, под которым осуществляется подключение к базе данных;</li><li>-D — целевая директория для записи данных;</li><li>-Ft — упаковка резервной копии в .tar-архив;</li><li>-z — упаковка резервной копии в архив формата .gz;</li><li>-Xf — включает все необходимые файлы журналов предзаписи (файлы WAL) в резервную копию. Файлы журнала предзаписи собираются в конце процесса копирования;</li><li>-P — отчет о прогрессе;</li><li>-v — информация о статусе резервного копирования.</li></ul></stepxmp></step><step><cmd>Убедитесь, что все содержимое директории <codeph>/var/lib/jatoba/[jatoba_version]/data</codeph>, где <codeph>jatoba_version</codeph> — первая цифра версии Jatoba, принадлежит пользователю <b>postgres</b>: </cmd><info><codeblock>chown postgres:postgres -R /var/lib/jatoba/[jatoba_version]/data</codeblock></info></step><step><cmd>Введите пароль пользователя <b>postgres</b> для доступа к базе данных. </cmd><stepresult>После успешного ввода начнется создание резервной копии файлов СУБД. Каталог для резервных копий файлов будет создан автоматически. </stepresult></step></steps></taskbody>
</task>
